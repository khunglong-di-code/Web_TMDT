<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gi·ªè h√†ng | T·∫•t T·∫ßn T·∫≠p</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="image/logo.png" type="image/png">

  <!-- CSS RI√äNG CHO TRANG GI·ªé H√ÄNG & TRA C·ª®U -->
  <style>
    /* CSS CHO KHU V·ª∞C TRA C·ª®U */
    .lookup-section {
        margin-top: 50px;
        padding-top: 30px;
        border-top: 2px dashed #ddd;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    .lookup-header h3 { font-size: 1.3rem; color: #333; margin-bottom: 5px; }
    .lookup-header p { color: #666; font-size: 0.9rem; margin-bottom: 15px; }

    .lookup-form { display: flex; gap: 10px; margin-bottom: 20px; }
    .lookup-form input {
        flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 6px; outline: none;
    }
    .lookup-form button {
        padding: 0 25px; background: #555; color: white; border: none; border-radius: 6px;
        cursor: pointer; font-weight: bold; transition: 0.3s;
    }
    .lookup-form button:hover { background: #333; }
    .lookup-form button:disabled { background: #ccc; cursor: not-allowed; }

    /* CSS K·∫æT QU·∫¢ TRA C·ª®U */
    .order-history-item {
        background: #fff; border: 1px solid #eee; padding: 15px; margin-bottom: 15px;
        border-radius: 8px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    /* M√†u tr·∫°ng th√°i */
    .status-pending { border-left-color: #f1c40f; } /* Ch·ªù x√°c nh·∫≠n (V√†ng) */
    .status-shipping { border-left-color: #3498db; } /* ƒêang giao (Xanh d∆∞∆°ng) */
    .status-done { border-left-color: #27ae60; }     /* ƒê√£ giao (Xanh l√°) */
    .status-cancel { border-left-color: #e74c3c; }   /* H·ªßy (ƒê·ªè) */

    .history-header { display: flex; justify-content: space-between; font-size: 0.9rem; color: #888; margin-bottom: 10px; }
    .history-body { font-weight: 500; color: #333; margin-bottom: 10px; line-height: 1.5; }
    .history-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 10px; }
    .history-price { color: #d35400; font-weight: bold; font-size: 1.1rem; }
    .history-status { background: #f0f0f0; padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; color: #333; }

    /* H·ªôp m√£ feedback */
    .fb-code-box {
        margin-top: 15px; background: #e8f5e9; color: #2e7d32; padding: 10px;
        border-radius: 6px; font-size: 0.95rem; text-align: center; border: 1px dashed #2e7d32;
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="index.html">
        <img src="image/Tattantap_logo1.png" alt="Logo">
      </a>
      <nav class="main-nav">
        <ul>
          <li><a href="index.html">Trang ch·ªß</a></li>      
          <li><a href="about.html">V·ªÅ ch√∫ng t√¥i</a></li>
          <li><a href="products.html">C·ª≠a h√†ng</a></li>
          <li><a href="faq.html">H·ªó tr·ª£</a></li>
        </ul>
      </nav>
      <div class="header-actions">
          <a class="cart-link" href="cart.html" style="color: #d35400;">
            <i class="fa-solid fa-bag-shopping"></i>
            <span class="cart-count" id="cart-count">0</span>
          </a>
      </div>
    </div>
  </header>

  <!-- N·ªòI DUNG CH√çNH -->
  <main class="cart-section">
    <h1>Gi·ªè h√†ng c·ªßa b·∫°n</h1>
    
    <!-- B·∫£ng gi·ªè h√†ng -->
    <table class="cart-table">
        <thead>
            <tr>
                <th>S·∫£n ph·∫©m</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>ƒê∆°n gi√°</th>
                <th>Th√†nh ti·ªÅn</th>
                <th>X√≥a</th>
            </tr>
        </thead>
        <tbody id="cart-body"></tbody>
    </table>

    <div class="total-section">
        T·ªïng c·ªông: <span id="cart-total" style="color: #f08146; font-size: 1.5rem;">0‚Ç´</span>
    </div>

    <!-- Form thanh to√°n -->
    <div class="checkout-form" id="checkout-section">
        <h2>Th√¥ng tin thanh to√°n</h2>
        <div class="form-group">
            <label>H·ªç v√† t√™n:</label>
            <input type="text" id="cus-name" placeholder="Nh·∫≠p h·ªç t√™n c·ªßa b·∫°n">
        </div>
        <div class="form-group">
            <label>ƒê·ªãa ch·ªâ giao h√†ng:</label>
            <textarea rows="3" id="cus-address" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, qu·∫≠n/huy·ªán..."></textarea>
        </div>
        <div class="form-group">
            <label>S·ªë ƒëi·ªán tho·∫°i:</label>
            <input type="tel" id="cus-phone" placeholder="09xxx...">
        </div>

        <div class="form-group">
            <label>H√¨nh th·ª©c thanh to√°n:</label>
            <div class="payment-methods">
                <div class="payment-option" onclick="selectPayment('cod')" id="pay-cod">
                    <i class="fa-solid fa-truck"></i> COD (Ti·ªÅn m·∫∑t)
                </div>
                <div class="payment-option" onclick="selectPayment('qr')" id="pay-qr">
                    <i class="fa-solid fa-qrcode"></i> Chuy·ªÉn kho·∫£n QR
                </div>
            </div>
            
            <div id="qr-code-image" style="display: none; margin-top: 15px; text-align: center;">
                <p>Vui l√≤ng qu√©t m√£ b√™n d∆∞·ªõi:</p>
                <!-- Thay link ·∫£nh QR th·∫≠t c·ªßa b·∫°n v√†o ƒë√¢y -->
                  <img src="image/qr.png">
                <p style="font-size: 0.9rem; color: #666;">N·ªôi dung CK: T√™n + SƒêT</p>
            </div>
        </div>

        <button class="btn-checkout" onclick="checkout()">ƒê·∫∂T H√ÄNG NGAY</button>
    </div>

    <!-- ============================================== -->
    <!-- KHU V·ª∞C TRA C·ª®U ƒê∆†N H√ÄNG (M·ªöI) -->
    <!-- ============================================== -->
    <section class="lookup-section">
        <div class="lookup-header">
            <h3><i class="fa-solid fa-magnifying-glass"></i> Tra C·ª©u ƒê∆°n H√†ng C≈©</h3>
            <p>Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ xem tr·∫°ng th√°i ƒë∆°n h√†ng & l·∫•y m√£ Feedback</p>
        </div>

        <div class="lookup-form">
            <input type="tel" id="lookup-phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n...">
            <button onclick="lookupOrder()" id="btn-lookup">Ki·ªÉm Tra</button>
        </div>

        <!-- Khu v·ª±c hi·ªÉn th·ªã k·∫øt qu·∫£ -->
        <div id="lookup-results"></div>
    </section>

  </main>

 <!-- Chat Plugin -->
 <div id="fb-root"></div>
 <div id="fb-customer-chat" class="fb-customerchat"></div>
 <script>
   var chatbox = document.getElementById('fb-customer-chat');
   chatbox.setAttribute("page_id", "61582495130534"); // ID Fanpage
   chatbox.setAttribute("attribution", "biz_inbox");
   window.fbAsyncInit = function() { FB.init({ xfbml : true, version : 'v18.0' }); };
   (function(d, s, id) {
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) return;
     js = d.createElement(s); js.id = id;
     js.src = 'https://connect.facebook.net/vi_VN/sdk/xfbml.customerchat.js';
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
 </script>

<!-- JAVASCRIPT LOGIC CHO CART.HTML -->
  <script>
    // --- C·∫§U H√åNH API ---
    const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxRrUyTKLc98YgQ5Ppjn6SOEzPF6RWt4NRfQ6VGFU_vFX1FpVOckUAeygKnLXFesp6yvQ/exec';

    // === 1. LOGIC GI·ªé H√ÄNG (ƒê√É N√ÇNG C·∫§P) ===
    function calculateSockPrice(size, qty) {
        let price = 0;
        // Logic gi√° t·∫•t theo s·ªë l∆∞·ª£ng
        if (size === 'S') { price = (qty >= 10) ? 6000 : (qty >= 5) ? 8000 : 10000; } 
        else if (size === 'M') { price = (qty >= 10) ? 8000 : (qty >= 5) ? 10000 : 12000; } 
        else if (size === 'L') { price = (qty >= 10) ? 10000 : (qty >= 5) ? 12000 : 14000; }
        return price;
    }

    function renderCart() {
        let cart = [];
        let tbody = document.getElementById('cart-body');
        let totalEl = document.getElementById('cart-total');
        
        // --- PH·∫¶N QUAN TR·ªåNG: ƒê·ªåC D·ªÆ LI·ªÜU AN TO√ÄN ---
        try {
            let rawData = localStorage.getItem('myCart');
            console.log("D·ªØ li·ªáu th√¥ trong LocalStorage:", rawData); // Ki·ªÉm tra F12 xem c√≥ d·ªØ li·ªáu kh√¥ng
            
            if (rawData) {
                cart = JSON.parse(rawData);
            }
        } catch (e) {
            console.error("D·ªØ li·ªáu gi·ªè h√†ng b·ªã l·ªói, ƒëang reset...", e);
            localStorage.removeItem('myCart');
            cart = [];
        }

        tbody.innerHTML = '';
        let grandTotal = 0;

        if (!cart || cart.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;">Gi·ªè h√†ng tr·ªëng</td></tr>';
            document.getElementById('checkout-section').style.display = 'none';
            totalEl.innerText = '0‚Ç´';
            updateCartCount(0);
            return;
        } else {
            document.getElementById('checkout-section').style.display = 'block';
        }

        // Duy·ªát qua t·ª´ng s·∫£n ph·∫©m ƒë·ªÉ hi·ªÉn th·ªã
        cart.forEach((item, index) => {
            // T√≠nh gi√°: N·∫øu l√† t·∫•t (sock) th√¨ t√≠nh theo b·∫£ng gi√°, n·∫øu l√† sp kh√°c th√¨ l·∫•y gi√° g·ªëc
            let unitPrice = (item.type === 'sock') ? calculateSockPrice(item.size, item.quantity) : parseInt(item.price);
            
            let subTotal = unitPrice * item.quantity;
            grandTotal += subTotal;

            // T·∫°o d√≤ng HTML
            let row = `
                <tr>
                    <td>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${item.image}" style="width:50px; height:50px; object-fit:cover; border-radius:4px;">
                            <div>
                                <strong>${item.name}</strong><br>
                                ${item.type === 'sock' ? `<small style="color:#666">Size: ${item.size}, M√†u: ${item.color}</small>` : ''}
                            </div>
                        </div>
                    </td>
                    <td>${item.quantity}</td>
                    <td>${unitPrice.toLocaleString('vi-VN')}‚Ç´</td>
                    <td>${subTotal.toLocaleString('vi-VN')}‚Ç´</td>
                    <td>
                        <button onclick="removeItem(${index})" style="color:red; border:none; background:none; cursor:pointer; font-size:1.1rem;">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        totalEl.innerText = grandTotal.toLocaleString('vi-VN') + '‚Ç´';
        updateCartCount(cart);
    }

    function removeItem(index) {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        cart.splice(index, 1);
        localStorage.setItem('myCart', JSON.stringify(cart));
        renderCart(); // V·∫Ω l·∫°i b·∫£ng sau khi x√≥a
    }

    function updateCartCount(cartData) {
        // N·∫øu kh√¥ng truy·ªÅn cartData v√†o th√¨ t·ª± l·∫•y l·∫°i
        let cart = cartData;
        if (!cart) {
            try { cart = JSON.parse(localStorage.getItem('myCart')) || []; } 
            catch { cart = []; }
        }
        
        // N·∫øu cart l√† s·ªë (do g·ªçi updateCartCount(0)) th√¨ g√°n lu√¥n
        let total = 0;
        if (Array.isArray(cart)) {
            total = cart.reduce((acc, item) => acc + item.quantity, 0);
        }
        
        // C·∫≠p nh·∫≠t s·ªë tr√™n icon
        const countEl = document.getElementById('cart-count');
        if(countEl) countEl.innerText = total;
    }

    // === 2. LOGIC THANH TO√ÅN ===
    let selectedPayment = null;

    function selectPayment(method) {
        selectedPayment = method;
        document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('active'));
        document.getElementById('qr-code-image').style.display = 'none';

        if (method === 'cod') {
            document.getElementById('pay-cod').classList.add('active');
        } else if (method === 'qr') {
            document.getElementById('pay-qr').classList.add('active');
            document.getElementById('qr-code-image').style.display = 'block';
        }
    }

    async function checkout() {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        if (cart.length === 0) { alert("Gi·ªè h√†ng tr·ªëng!"); return; }

        let name = document.getElementById('cus-name').value.trim();
        let address = document.getElementById('cus-address').value.trim();
        let phone = document.getElementById('cus-phone').value.trim();

        if (!name || !address || !phone) { alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!"); return; }
        if (!selectedPayment) { alert("Vui l√≤ng ch·ªçn h√¨nh th·ª©c thanh to√°n!"); return; }

        let orderData = {
            customer: { name: name, phone: phone, address: address },
            payment_method: selectedPayment,
            items: cart,
            total_price: document.getElementById('cart-total').innerText
        };

        let btn = document.querySelector('.btn-checkout');
        let originalText = btn.innerText;
        btn.innerText = "ƒêang g·ª≠i ƒë∆°n h√†ng...";
        btn.disabled = true;

        try {
            await fetch(API_ENDPOINT, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            document.querySelector('.cart-section').innerHTML = `
                <div style="text-align:center; padding:50px;">
                    <i class="fa-solid fa-circle-check" style="color:green; font-size:60px; margin-bottom:20px;"></i>
                    <h2>ƒê·∫∂T H√ÄNG TH√ÄNH C√îNG!</h2>
                    <p>C·∫£m ∆°n <strong>${name}</strong> ƒë√£ ·ªßng h·ªô.</p>
                    <p>Ch√∫ng t√¥i s·∫Ω s·ªõm li√™n h·ªá qua SƒêT: <strong>${phone}</strong> ƒë·ªÉ x√°c nh·∫≠n.</p>
                    <a href="index.html" style="display:inline-block; margin-top:30px; background:#333; color:#fff; padding:10px 20px; text-decoration:none; border-radius:5px;">Ti·∫øp t·ª•c mua s·∫Øm</a>
                </div>
            `;
            localStorage.removeItem('myCart');
            updateCartCount([]);

        } catch (error) {
            console.error("L·ªói:", error);
            alert("‚ö†Ô∏è C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!");
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function lookupOrder() {
        const phoneInput = document.getElementById('lookup-phone').value;
        const phone = phoneInput ? phoneInput.trim() : "";
        const btn = document.getElementById('btn-lookup');
        const resultDiv = document.getElementById('lookup-results');

        if (!phone) { alert("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!"); return; }

        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang t√¨m...';
        btn.disabled = true;
        resultDiv.innerHTML = "";

        const requestUrl = `${API_ENDPOINT}?phone=${phone}`;

        fetch(requestUrl)
        .then(response => response.json())
        .then(data => {
            if (data.result === 'success') {
                if (!data.orders || data.orders.length === 0) {
                    resultDiv.innerHTML = `<div style="text-align:center; padding:20px; color:#666; background:#fff; border:1px solid #eee;">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng v·ªõi SƒêT <strong>${phone}</strong></div>`;
                    return;
                }
                let html = `<p style="margin-bottom:15px; color:#2e7d32; font-weight:bold;">T√¨m th·∫•y ${data.orders.length} ƒë∆°n h√†ng:</p>`;
                
                data.orders.forEach(order => {
                    let statusClass = 'status-pending';
                    if (order.status.includes('ƒêang')) statusClass = 'status-shipping';
                    else if (order.status.includes('ƒê√£')) statusClass = 'status-done';
                    else if (order.status.includes('H·ªßy')) statusClass = 'status-cancel';
                    
                    let fbHtml = (order.fb_code && order.fb_code.trim()) ? `<div class="fb-code-box">üéÅ M√£: <strong>${order.fb_code}</strong></div>` : '';

                    html += `<div class="order-history-item ${statusClass}">
                        <div class="history-header"><span>üìÖ ${order.date}</span></div>
                        <div class="history-body">${order.products ? order.products.replace(/\n/g, '<br>') : ''}</div>
                        <div class="history-footer">
                            <span class="history-price">${order.total}</span>
                            <span class="history-status">${order.status}</span>
                        </div>
                        ${fbHtml}
                    </div>`;
                });
                resultDiv.innerHTML = html;
            } else {
                resultDiv.innerHTML = `<div style="color:red; text-align:center;">${data.message || "L·ªói server"}</div>`;
            }
        })
        .catch(err => {
            console.error(err);
            resultDiv.innerHTML = `<div style="color:red; text-align:center;">L·ªói k·∫øt n·ªëi!</div>`;
        })
        .finally(() => {
            btn.innerHTML = "Ki·ªÉm Tra";
            btn.disabled = false;
        });
    }

    // CH·∫†Y KHI T·∫¢I TRANG
    // ƒê·ªÉ ƒë·∫£m b·∫£o HTML ƒë√£ load xong, ta b·ªçc trong DOMContentLoaded (tu·ª≥ ch·ªçn)
    document.addEventListener('DOMContentLoaded', () => {
        renderCart();
    });
  </script>

</body>
</html>
