<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Giỏ hàng | Tất Tần Tập</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="image/logo.png" type="image/png">

  <!-- CSS RIÊNG CHO TRANG GIỎ HÀNG & TRA CỨU -->
  <style>
    /* CSS CHO KHU VỰC TRA CỨU */
    .lookup-section {
        margin-top: 50px;
        padding-top: 30px;
        border-top: 2px dashed #ddd;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    .lookup-header h3 { font-size: 1.3rem; color: #333; margin-bottom: 5px; }
    .lookup-header p { color: #666; font-size: 0.9rem; margin-bottom: 15px; }

    .lookup-form { display: flex; gap: 10px; margin-bottom: 20px; }
    .lookup-form input {
        flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 6px; outline: none;
    }
    .lookup-form button {
        padding: 0 25px; background: #555; color: white; border: none; border-radius: 6px;
        cursor: pointer; font-weight: bold; transition: 0.3s;
    }
    .lookup-form button:hover { background: #333; }
    .lookup-form button:disabled { background: #ccc; cursor: not-allowed; }

    /* CSS KẾT QUẢ TRA CỨU */
    .order-history-item {
        background: #fff; border: 1px solid #eee; padding: 15px; margin-bottom: 15px;
        border-radius: 8px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    /* Màu trạng thái */
    .status-pending { border-left-color: #f1c40f; } /* Chờ xác nhận (Vàng) */
    .status-shipping { border-left-color: #3498db; } /* Đang giao (Xanh dương) */
    .status-done { border-left-color: #27ae60; }     /* Đã giao (Xanh lá) */
    .status-cancel { border-left-color: #e74c3c; }   /* Hủy (Đỏ) */

    .history-header { display: flex; justify-content: space-between; font-size: 0.9rem; color: #888; margin-bottom: 10px; }
    .history-body { font-weight: 500; color: #333; margin-bottom: 10px; line-height: 1.5; }
    .history-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 10px; }
    .history-price { color: #d35400; font-weight: bold; font-size: 1.1rem; }
    .history-status { background: #f0f0f0; padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; color: #333; }

    /* Hộp mã feedback */
    .fb-code-box {
        margin-top: 15px; background: #e8f5e9; color: #2e7d32; padding: 10px;
        border-radius: 6px; font-size: 0.95rem; text-align: center; border: 1px dashed #2e7d32;
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="index.html">
        <img src="image/Tattantap_logo1.png" alt="Logo">
      </a>
      <nav class="main-nav">
        <ul>
          <li><a href="index.html">Trang chủ</a></li>      
          <li><a href="about.html">Về chúng tôi</a></li>
          <li><a href="products.html">Cửa hàng</a></li>
          <li><a href="faq.html">Hỗ trợ</a></li>
        </ul>
      </nav>
      <div class="header-actions">
          <a class="cart-link" href="cart.html" style="color: #d35400;">
            <i class="fa-solid fa-bag-shopping"></i>
            <span class="cart-count" id="cart-count">0</span>
          </a>
      </div>
    </div>
  </header>

  <!-- NỘI DUNG CHÍNH -->
  <main class="cart-section">
    <h1>Giỏ hàng của bạn</h1>
    
    <!-- Bảng giỏ hàng -->
    <table class="cart-table">
        <thead>
            <tr>
                <th>Sản phẩm</th>
                <th>Số lượng</th>
                <th>Đơn giá</th>
                <th>Thành tiền</th>
                <th>Xóa</th>
            </tr>
        </thead>
        <tbody id="cart-body"></tbody>
    </table>

    <div class="total-section">
        Tổng cộng: <span id="cart-total" style="color: #f08146; font-size: 1.5rem;">0₫</span>
    </div>

    <!-- Form thanh toán -->
    <div class="checkout-form" id="checkout-section">
        <h2>Thông tin thanh toán</h2>
        <div class="form-group">
            <label>Họ và tên:</label>
            <input type="text" id="cus-name" placeholder="Nhập họ tên của bạn">
        </div>
        <div class="form-group">
            <label>Địa chỉ giao hàng:</label>
            <textarea rows="3" id="cus-address" placeholder="Số nhà, đường, quận/huyện..."></textarea>
        </div>
        <div class="form-group">
            <label>Số điện thoại:</label>
            <input type="tel" id="cus-phone" placeholder="09xxx...">
        </div>

        <div class="form-group">
            <label>Hình thức thanh toán:</label>
            <div class="payment-methods">
                <div class="payment-option" onclick="selectPayment('cod')" id="pay-cod">
                    <i class="fa-solid fa-truck"></i> COD (Tiền mặt)
                </div>
                <div class="payment-option" onclick="selectPayment('qr')" id="pay-qr">
                    <i class="fa-solid fa-qrcode"></i> Chuyển khoản QR
                </div>
            </div>
            
            <div id="qr-code-image" style="display: none; margin-top: 15px; text-align: center;">
                <p>Vui lòng quét mã bên dưới:</p>
                <!-- Thay link ảnh QR thật của bạn vào đây -->
                <img src="https://via.placeholder.com/200x200.png?text=QR+Code" alt="Mã QR" style="max-width: 200px;">
                <p style="font-size: 0.9rem; color: #666;">Nội dung CK: Tên + SĐT</p>
            </div>
        </div>

        <button class="btn-checkout" onclick="checkout()">ĐẶT HÀNG NGAY</button>
    </div>

    <!-- ============================================== -->
    <!-- KHU VỰC TRA CỨU ĐƠN HÀNG (MỚI) -->
    <!-- ============================================== -->
    <section class="lookup-section">
        <div class="lookup-header">
            <h3><i class="fa-solid fa-magnifying-glass"></i> Tra Cứu Đơn Hàng Cũ</h3>
            <p>Nhập số điện thoại để xem trạng thái đơn hàng & lấy mã Feedback</p>
        </div>

        <div class="lookup-form">
            <input type="tel" id="lookup-phone" placeholder="Nhập số điện thoại của bạn...">
            <button onclick="lookupOrder()" id="btn-lookup">Kiểm Tra</button>
        </div>

        <!-- Khu vực hiển thị kết quả -->
        <div id="lookup-results"></div>
    </section>

  </main>

 <!-- Chat Plugin -->
 <div id="fb-root"></div>
 <div id="fb-customer-chat" class="fb-customerchat"></div>
 <script>
   var chatbox = document.getElementById('fb-customer-chat');
   chatbox.setAttribute("page_id", "61582495130534"); // ID Fanpage
   chatbox.setAttribute("attribution", "biz_inbox");
   window.fbAsyncInit = function() { FB.init({ xfbml : true, version : 'v18.0' }); };
   (function(d, s, id) {
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) return;
     js = d.createElement(s); js.id = id;
     js.src = 'https://connect.facebook.net/vi_VN/sdk/xfbml.customerchat.js';
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
 </script>

  <!-- JAVASCRIPT LOGIC -->
  <script>
    // --- 1. CẤU HÌNH API ---
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwg7NjJmkQ_12OOHY8pQWaWBtdv5BHQjzSVOqYzrefHcrJw97lMdKRYMY8jwvceaHCbbQ/exec";

    // --- 2. DỮ LIỆU SẢN PHẨM (MOCK DATA) ---
    const productsDB = {
        'sock': {
            name: "Tất Cotton Premium",
            type: 'sock',
            images: ["image/1.png", "image/conganden.png", "image/colung1den.png"],
            desc: "<p><strong>Chất liệu:</strong> 90% Cotton tự nhiên, 10% Spandex giúp co giãn 4 chiều.</p>"
        },
        'book': {
            name: "Sổ Tay Minimalist",
            type: 'book',
            price_fixed: 35000,
            images: ["image/sach1.png", "image/sach2.png"],
            desc: "<p><strong>Loại giấy:</strong> Giấy kem ngà chống lóa, định lượng 100gsm dày dặn.</p>"
        }
    };

    const params = new URLSearchParams(window.location.search);
    const productId = params.get('id') || 'sock'; // Mặc định là sock
    const productData = productsDB[productId];

    // --- 3. KHỞI TẠO TRANG ---
    function initPage() {
        if (!productData) {
            document.querySelector('.detail-container').innerHTML = "<h2>Không tìm thấy sản phẩm!</h2>";
            return;
        }

        // Hiển thị thông tin
        document.getElementById('p-name').innerText = productData.name;
        document.getElementById('p-desc').innerHTML = productData.desc;
        
        const mainImg = document.getElementById('main-img');
        const thumbContainer = document.getElementById('thumb-container');
        mainImg.src = productData.images[0];

        productData.images.forEach((src, index) => {
            let thumb = document.createElement('img');
            thumb.src = src;
            thumb.className = index === 0 ? 'thumb-item active' : 'thumb-item';
            thumb.onclick = () => {
                mainImg.src = src;
                document.querySelectorAll('.thumb-item').forEach(el => el.classList.remove('active'));
                thumb.classList.add('active');
            }
            thumbContainer.appendChild(thumb);
        });

        if (productData.type === 'book') {
            document.getElementById('options-area').style.display = 'none';
        }

        updatePrice();
        updateCartCount();
        
        // GỌI HÀM TẢI FEEDBACK TỪ API
        loadReviewsFromSheet();
    }

    // --- 4. LOGIC GIÁ & GIỎ HÀNG (ĐÃ SỬA) ---
    function updatePrice() {
        const qty = parseInt(document.getElementById('sel-qty').value) || 1;
        let unitPrice = 0;
        if (productData.type === 'sock') {
            const size = document.getElementById('sel-size').value;
            unitPrice = (size === 'S') ? 10000 : (size === 'M') ? 12000 : 14000;
            if(qty >= 5) unitPrice -= 2000;
        } else {
            unitPrice = productData.price_fixed;
        }
        document.getElementById('p-price').innerText = `${(unitPrice * qty).toLocaleString('vi-VN')}₫`;
    }

    // --- HÀM ADD TO CART ĐƯỢC SỬA LẠI ---
    function addToCart() {
        const qtyInput = document.getElementById('sel-qty');
        const qty = parseInt(qtyInput.value) || 1;

        // Tạo object sản phẩm để lưu
        let item = {
            id: productId,
            name: productData.name,
            type: productData.type,
            quantity: qty,
            image: productData.images[0]
        };

        // Lấy thông tin size/màu nếu là tất
        if (productData.type === 'sock') {
            item.size = document.getElementById('sel-size').value;
            item.color = document.getElementById('sel-color').value;
            item.price = 0; // Giá tất sẽ được tính lại trong cart.html dựa trên tổng số lượng
        } else {
            // Sách hoặc sản phẩm khác có giá cố định
            item.price = productData.price_fixed;
            item.size = "";  // Không có size
            item.color = ""; // Không có màu
        }

        // Lấy giỏ hàng cũ từ LocalStorage
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];

        // Kiểm tra xem sản phẩm này (cùng size, cùng màu) đã có trong giỏ chưa
        let existingItem = cart.find(x => x.id === item.id && x.size === item.size && x.color === item.color);

        if (existingItem) {
            existingItem.quantity += qty; // Nếu có rồi thì cộng thêm số lượng
        } else {
            cart.push(item); // Nếu chưa thì thêm mới
        }

        // Lưu ngược lại vào LocalStorage
        localStorage.setItem('myCart', JSON.stringify(cart));

        // Cập nhật số lượng trên icon giỏ hàng header ngay lập tức
        updateCartCount();

        alert(`Đã thêm ${qty} sản phẩm "${item.name}" vào giỏ hàng!`);
    }

    function updateCartCount() {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        let total = cart.reduce((acc, item) => acc + item.quantity, 0);
        document.getElementById('cart-count').innerText = total;
    }

    // --- 5. TÍNH NĂNG FEEDBACK (KẾT NỐI API) ---

    // A. Tải danh sách đánh giá
    function loadReviewsFromSheet() {
        const list = document.getElementById('review-list');
        
        // Gọi API với tham số id sản phẩm
        fetch(`${GOOGLE_SCRIPT_URL}?id=${productId}`)
            .then(response => response.json())
            .then(data => {
                list.innerHTML = ""; // Xóa icon loading
                
                if (!Array.isArray(data) || data.length === 0) {
                    list.innerHTML = '<div style="text-align:center; color:#999; padding:15px;">Chưa có feedback nào. Hãy là người đầu tiên!</div>';
                    return;
                }

                data.forEach(rv => {
                    const stars = '★'.repeat(rv.rating) + '☆'.repeat(5 - rv.rating);
                    const dateStr = new Date(rv.date).toLocaleDateString('vi-VN');
                    
                    const html = `
                        <div class="review-item">
                            <div class="review-header">
                                <span class="reviewer-name">${rv.name}</span>
                                <span class="review-stars">${stars}</span>
                            </div>
                            <div class="review-content">${rv.comment}</div>
                            <span class="review-date">${dateStr}</span>
                        </div>
                    `;
                    list.insertAdjacentHTML('beforeend', html);
                });
            })
            .catch(error => {
                console.error('Lỗi tải feedback:', error);
                list.innerHTML = '<div style="color:red; text-align:center; padding:10px;">Không tải được đánh giá.</div>';
            });
    }

    // B. Gửi đánh giá mới
    function submitFeedback() {
        const name = document.getElementById('fb-name').value.trim() || 'Khách hàng';
        const code = document.getElementById('fb-code').value.trim();
        const rating = document.getElementById('fb-rating').value;
        const comment = document.getElementById('fb-comment').value.trim();
        const btn = document.getElementById('btn-submit');

        if (!code) { 
            alert("Vui lòng nhập Mã đơn hàng để xác minh!"); 
            document.getElementById('fb-code').focus();
            return; 
        }
        if (!comment) { 
            alert("Bạn hãy viết vài lời nhận xét nhé!"); 
            document.getElementById('fb-comment').focus();
            return; 
        }

        // Khóa nút submit
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang gửi...';
        btn.disabled = true;

        // Tạo gói dữ liệu gửi đi (QUAN TRỌNG: type='feedback')
        const payload = {
            type: 'feedback', // Để server biết đây là feedback chứ không phải đặt hàng
            product_id: productId,
            name: name,
            code: code,
            rating: rating,
            comment: comment
        };

        // Gửi POST request
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(payload) // App Script sẽ đọc qua e.postData.contents
        })
        .then(response => response.json())
        .then(data => {
            if (data.result === 'success') {
                alert("✅ Cảm ơn bạn! Feedback đã được ghi nhận.");
                
                // Xóa form
                document.getElementById('fb-comment').value = '';
                document.getElementById('fb-code').value = '';
                document.getElementById('fb-name').value = '';

                // Tải lại danh sách ngay lập tức
                loadReviewsFromSheet();
            } 
            else if (data.result === 'duplicate') {
                alert("⚠️ Lỗi: Mã đơn hàng này đã được sử dụng để đánh giá rồi!");
                document.getElementById('fb-code').focus();
            } 
            else {
                alert("❌ Lỗi server: " + (data.message || data.error));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Có lỗi kết nối. Vui lòng thử lại sau!");
        })
        .finally(() => {
            // Mở lại nút submit
            btn.innerHTML = 'GỬI FEEDBACK';
            btn.disabled = false;
        });
    }

    // Chạy khi tải trang
    initPage();
  </script>

</body>
</html>
