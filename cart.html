<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gi·ªè h√†ng | T·∫•t T·∫ßn T·∫≠p</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="image/Tattantap_logo1.png" type="image/png">
</head>
<body>

    <header class="site-header">
        <div class="header-inner">
          <a class="logo" href="index.html">
            <img src="image/Tattantap_logo1.png" alt="Logo">
          </a>
          <nav class="main-nav">
            <ul>
              <!-- ƒê√£ b·ªè class active ·ªü ƒë√¢y -->
              <li><a href="index.html">Trang ch·ªß</a></li>      
              <li><a href="about.html">V·ªÅ ch√∫ng t√¥i</a></li>
              <li><a href="products.html">C·ª≠a h√†ng</a></li>
              <li><a href="faq.html">H·ªó tr·ª£</a></li>
            </ul>
          </nav>
          <div class="header-actions">
              <!-- Th√™m style color ƒë·ªÉ l√†m n·ªïi b·∫≠t icon gi·ªè h√†ng -->
              <a class="cart-link" href="cart.html" style="color: #d35400;">
                <i class="fa-solid fa-bag-shopping"></i>
                <span class="cart-count" id="cart-count">0</span>
              </a>
          </div>
        </div>
      </header>

  <main class="cart-section">
    <h1>Gi·ªè h√†ng c·ªßa b·∫°n</h1>
    
    <table class="cart-table">
        <thead>
            <tr>
                <th>S·∫£n ph·∫©m</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>ƒê∆°n gi√° (theo m·ª©c)</th>
                <th>Th√†nh ti·ªÅn</th>
                <th>X√≥a</th>
            </tr>
        </thead>
        <tbody id="cart-body">
            </tbody>
    </table>

    <div class="total-section">
        T·ªïng c·ªông: <span id="cart-total" style="color: #f08146; font-size: 1.5rem;">0‚Ç´</span>
    </div>

<!-- T√¨m ƒëo·∫°n n√†y trong cart.html v√† s·ª≠a l·∫°i gi·ªëng h·ªát b√™n d∆∞·ªõi -->
<div class="checkout-form" id="checkout-section">
    <h2>Th√¥ng tin thanh to√°n</h2>
    <div class="form-group">
        <label>H·ªç v√† t√™n:</label>
        <!-- Th√™m id="cus-name" -->
        <input type="text" id="cus-name" placeholder="Nh·∫≠p h·ªç t√™n c·ªßa b·∫°n">
    </div>
    <div class="form-group">
        <label>ƒê·ªãa ch·ªâ giao h√†ng:</label>
        <!-- Th√™m id="cus-address" -->
        <textarea rows="3" id="cus-address" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, qu·∫≠n/huy·ªán..."></textarea>
    </div>
    <div class="form-group">
        <label>S·ªë ƒëi·ªán tho·∫°i:</label>
        <!-- Th√™m id="cus-phone" -->
        <input type="tel" id="cus-phone" placeholder="09xxx...">
    </div>

    <!-- ... C√°c ph·∫ßn b√™n d∆∞·ªõi gi·ªØ nguy√™n ... -->

        <div class="form-group">
            <label>H√¨nh th·ª©c thanh to√°n:</label>
            <div class="payment-methods">
                <div class="payment-option" onclick="selectPayment('cod')" id="pay-cod">
                    <i class="fa-solid fa-truck"></i> COD (Ti·ªÅn m·∫∑t)
                </div>
                <div class="payment-option" onclick="selectPayment('qr')" id="pay-qr">
                    <i class="fa-solid fa-qrcode"></i> Chuy·ªÉn kho·∫£n QR
                </div>
            </div>
            
            <div id="qr-code-image">
                <p>Vui l√≤ng qu√©t m√£ b√™n d∆∞·ªõi:</p>
                <img src="https://via.placeholder.com/200x200.png?text=QR+Code+Here" alt="M√£ QR Chuy·ªÉn kho·∫£n">
                <p>N·ªôi dung CK: T√™n + SƒêT</p>
            </div>
        </div>

        <button class="btn-checkout" onclick="checkout()">ƒê·∫∂T H√ÄNG NGAY</button>
    </div>

  </main>

 <!-- Messenger Chat Plugin Code -->
<div id="fb-root"></div>

<!-- Your Chat Plugin code -->
<div id="fb-customer-chat" class="fb-customerchat">
</div>

<script>
  var chatbox = document.getElementById('fb-customer-chat');
  
  // üëáüëáüëá THAY ID FANPAGE C·ª¶A B·∫†N V√ÄO D√íNG D∆Ø·ªöI ƒê√ÇY üëáüëáüëá
  // V√≠ d·ª•: chatbox.setAttribute("page_id", "105682495130534");
  chatbox.setAttribute("page_id", "61582495130534N");
  
  chatbox.setAttribute("attribution", "biz_inbox");

  // ƒêo·∫°n m√£ chu·∫©n c·ªßa Facebook ƒë·ªÉ t·∫£i SDK
  window.fbAsyncInit = function() {
    FB.init({
      xfbml            : true,
      version          : 'v18.0'
    });
  };

  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = 'https://connect.facebook.net/vi_VN/sdk/xfbml.customerchat.js';
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

  <script>
    // === LOGIC T√çNH GI√Å TI·ªÄN (QUAN TR·ªåNG) ===
    function calculateSockPrice(size, qty) {
        let price = 0;
        // Size S (Nh·ªè)
        if (size === 'S') {
            if (qty >= 10) price = 6000;
            else if (qty >= 5) price = 8000;
            else price = 10000;
        } 
        // Size M (V·ª´a)
        else if (size === 'M') {
            if (qty >= 10) price = 8000;
            else if (qty >= 5) price = 10000;
            else price = 12000;
        }
        // Size L (L·ªõn)
        else if (size === 'L') {
            if (qty >= 10) price = 10000;
            else if (qty >= 5) price = 12000;
            else price = 14000;
        }
        return price;
    }

    function renderCart() {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        let tbody = document.getElementById('cart-body');
        let totalEl = document.getElementById('cart-total');
        tbody.innerHTML = '';
        let grandTotal = 0;

        if (cart.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Gi·ªè h√†ng tr·ªëng</td></tr>';
            document.getElementById('checkout-section').style.display = 'none';
            totalEl.innerText = '0‚Ç´';
            return;
        } else {
            document.getElementById('checkout-section').style.display = 'block';
        }

        cart.forEach((item, index) => {
            let unitPrice = 0;

            if (item.type === 'sock') {
                unitPrice = calculateSockPrice(item.size, item.quantity);
            } else {
                unitPrice = item.price; // Gi√° c·ªë ƒë·ªãnh cho S·ªï
            }

            let subTotal = unitPrice * item.quantity;
            grandTotal += subTotal;

            let row = `
                <tr>
                    <td>
                        <strong>${item.name}</strong><br>
                        ${item.type === 'sock' ? `<small>Size: ${item.size}, M√†u: ${item.color}</small>` : ''}
                    </td>
                    <td>${item.quantity}</td>
                    <td>${unitPrice.toLocaleString('vi-VN')}‚Ç´</td>
                    <td>${subTotal.toLocaleString('vi-VN')}‚Ç´</td>
                    <td><button onclick="removeItem(${index})" style="color:red; border:none; background:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        totalEl.innerText = grandTotal.toLocaleString('vi-VN') + '‚Ç´';
    }

    function removeItem(index) {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        cart.splice(index, 1);
        localStorage.setItem('myCart', JSON.stringify(cart));
        renderCart();
    }

    // === LOGIC THANH TO√ÅN ===
    let selectedPayment = null;

    function selectPayment(method) {
        selectedPayment = method;
        // Reset style
        document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('active'));
        document.getElementById('qr-code-image').style.display = 'none';

        // Set active
        if (method === 'cod') {
            document.getElementById('pay-cod').classList.add('active');
        } else if (method === 'qr') {
            document.getElementById('pay-qr').classList.add('active');
            document.getElementById('qr-code-image').style.display = 'block';
        }
    }


    async function checkout() {
        // --- VALIDATION ---
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        if (cart.length === 0) { alert("Gi·ªè h√†ng tr·ªëng!"); return; }

        let name = document.getElementById('cus-name').value.trim();
        let address = document.getElementById('cus-address').value.trim();
        let phone = document.getElementById('cus-phone').value.trim();

        if (name === "") { alert("Vui l√≤ng nh·∫≠p t√™n!"); document.getElementById('cus-name').focus(); return; }
        if (address === "") { alert("Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ!"); document.getElementById('cus-address').focus(); return; }
        if (phone === "") { alert("Vui l√≤ng nh·∫≠p SƒêT!"); document.getElementById('cus-phone').focus(); return; }
        if (!/(0[3|5|7|8|9])+([0-9]{8})\b/.test(phone)) { alert("SƒêT kh√¥ng h·ª£p l·ªá!"); document.getElementById('cus-phone').focus(); return; }
        if (!selectedPayment) { alert("Vui l√≤ng ch·ªçn thanh to√°n!"); return; }

        // --- PAYLOAD ---
        let orderData = {
            customer: { name: name, phone: phone, address: address },
            payment_method: selectedPayment,
            items: cart,
            total_price: document.getElementById('cart-total').innerText
        };

        // LINK C·ª¶A B·∫†N (ƒê·∫£m b·∫£o ƒë√£ set quy·ªÅn Anyone)
        const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwo1JtpJ-2ASGMNhz1jJwb8AWmsCyPI-1I0xn9pzKFwcaTvnjxcIQDCC2QGzXAuAxbwcg/exec'; 

        // --- UI UPDATE ---
        let btn = document.querySelector('.btn-checkout');
        let originalText = btn.innerText;
        btn.innerText = "ƒêang g·ª≠i ƒë∆°n h√†ng...";
        btn.disabled = true;

        try {
            // --- G·ª¨I D·ªÆ LI·ªÜU ---
            // D√πng no-cors ho·∫∑c text/plain ƒë·ªÉ g·ª≠i ƒë∆∞·ª£c sang Google Script
            await fetch(API_ENDPOINT, {
                method: 'POST',
                mode: 'no-cors', // Quan tr·ªçng: B·ªè qua ki·ªÉm tra CORS c·ªßa tr√¨nh duy·ªát
                headers: {
                    'Content-Type': 'application/json' // Khi d√πng no-cors, header n√†y ch·ªâ mang t√≠nh tham kh·∫£o
                },
                body: JSON.stringify(orderData)
            });

            // V√¨ d√πng mode 'no-cors', ta kh√¥ng bi·∫øt ch·∫Øc ch·∫Øn server tr·∫£ v·ªÅ g√¨ (opaque response)
            // Nh∆∞ng n·∫øu code ch·∫°y ƒë·∫øn d√≤ng n√†y m√† kh√¥ng nh·∫£y v√†o catch th√¨ coi nh∆∞ th√†nh c√¥ng 99%
            alert("üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng! Ch√∫ng t√¥i s·∫Ω li√™n h·ªá s·ªõm.");
            localStorage.removeItem('myCart');
            window.location.href = 'index.html';

        } catch (error) {
            console.error("L·ªói:", error);
            alert("‚ö†Ô∏è L·ªói k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra m·∫°ng ho·∫∑c th·ª≠ l·∫°i sau.");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
    

    // Ch·∫°y khi t·∫£i trang
    renderCart();
  </script>

</body>
</html>
