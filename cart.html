<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gi·ªè h√†ng | T·∫•t T·∫ßn T·∫≠p</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="image/logo.png" type="image/png">

  <!-- TH√äM CSS CHO PH·∫¶N TRA C·ª®U -->
  <style>
    /* CSS CHO KHU V·ª∞C TRA C·ª®U TRONG CART */
    .lookup-section {
        margin-top: 50px;
        padding-top: 30px;
        border-top: 2px dashed #ddd; /* ƒê∆∞·ªùng k·∫ª ph√¢n c√°ch */
        max-width: 800px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông cho ƒë·∫πp */
        margin-left: auto;
        margin-right: auto;
    }

    .lookup-header h3 {
        font-size: 1.3rem;
        color: #333;
        margin-bottom: 5px;
    }

    .lookup-header p {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 15px;
    }

    .lookup-form {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .lookup-form input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        outline: none;
    }

    .lookup-form button {
        padding: 0 25px;
        background: #555; 
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.3s;
    }

    .lookup-form button:hover {
        background: #333;
    }

    /* CSS K·∫æT QU·∫¢ TRA C·ª®U (Card ƒë∆°n h√†ng) */
    .order-history-item {
        background: #f9f9f9;
        border: 1px solid #eee;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #ccc;
    }

    /* M√†u tr·∫°ng th√°i */
    .order-history-item.status-pending { border-left-color: #f1c40f; } /* V√†ng */
    .order-history-item.status-shipping { border-left-color: #3498db; } /* Xanh */
    .order-history-item.status-done { border-left-color: #27ae60; } /* Xanh l√° */
    .order-history-item.status-cancel { border-left-color: #e74c3c; } /* ƒê·ªè */

    .history-header {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        color: #888;
        margin-bottom: 8px;
    }

    .history-body {
        font-weight: 500;
        color: #333;
        margin-bottom: 8px;
        white-space: pre-line;
    }

    .history-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid #eee;
        padding-top: 8px;
    }

    .history-price { color: #d35400; font-weight: bold; }
    .history-status { background: #e0e0e0; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }

    /* M√£ feedback */
    .fb-code-box {
        margin-top: 10px;
        background: #dff0d8;
        color: #3c763d;
        padding: 8px;
        border-radius: 4px;
        font-size: 0.9rem;
        text-align: center;
        border: 1px dashed #3c763d;
    }
  </style>
</head>
<body>

    <header class="site-header">
        <div class="header-inner">
          <a class="logo" href="index.html">
            <img src="image/Tattantap_logo1.png" alt="Logo">
          </a>
          <nav class="main-nav">
            <ul>
              <li><a href="index.html">Trang ch·ªß</a></li>      
              <li><a href="about.html">V·ªÅ ch√∫ng t√¥i</a></li>
              <li><a href="products.html">C·ª≠a h√†ng</a></li>
              <li><a href="faq.html">H·ªó tr·ª£</a></li>
            </ul>
          </nav>
          <div class="header-actions">
              <a class="cart-link" href="cart.html" style="color: #d35400;">
                <i class="fa-solid fa-bag-shopping"></i>
                <span class="cart-count" id="cart-count">0</span>
              </a>
          </div>
        </div>
      </header>

  <main class="cart-section">
    <h1>Gi·ªè h√†ng c·ªßa b·∫°n</h1>
    
    <table class="cart-table">
        <thead>
            <tr>
                <th>S·∫£n ph·∫©m</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>ƒê∆°n gi√° (theo m·ª©c)</th>
                <th>Th√†nh ti·ªÅn</th>
                <th>X√≥a</th>
            </tr>
        </thead>
        <tbody id="cart-body">
            </tbody>
    </table>

    <div class="total-section">
        T·ªïng c·ªông: <span id="cart-total" style="color: #f08146; font-size: 1.5rem;">0‚Ç´</span>
    </div>

    <div class="checkout-form" id="checkout-section">
        <h2>Th√¥ng tin thanh to√°n</h2>
        <div class="form-group">
            <label>H·ªç v√† t√™n:</label>
            <input type="text" id="cus-name" placeholder="Nh·∫≠p h·ªç t√™n c·ªßa b·∫°n">
        </div>
        <div class="form-group">
            <label>ƒê·ªãa ch·ªâ giao h√†ng:</label>
            <textarea rows="3" id="cus-address" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, qu·∫≠n/huy·ªán..."></textarea>
        </div>
        <div class="form-group">
            <label>S·ªë ƒëi·ªán tho·∫°i:</label>
            <input type="tel" id="cus-phone" placeholder="09xxx...">
        </div>

        <div class="form-group">
            <label>H√¨nh th·ª©c thanh to√°n:</label>
            <div class="payment-methods">
                <div class="payment-option" onclick="selectPayment('cod')" id="pay-cod">
                    <i class="fa-solid fa-truck"></i> COD (Ti·ªÅn m·∫∑t)
                </div>
                <div class="payment-option" onclick="selectPayment('qr')" id="pay-qr">
                    <i class="fa-solid fa-qrcode"></i> Chuy·ªÉn kho·∫£n QR
                </div>
            </div>
            
            <div id="qr-code-image">
                <p>Vui l√≤ng qu√©t m√£ b√™n d∆∞·ªõi:</p>
                <img src="https://via.placeholder.com/200x200.png?text=QR+Code+Here" alt="M√£ QR Chuy·ªÉn kho·∫£n">
                <p>N·ªôi dung CK: T√™n + SƒêT</p>
            </div>
        </div>

        <button class="btn-checkout" onclick="checkout()">ƒê·∫∂T H√ÄNG NGAY</button>
    </div>

    <!-- ============================================== -->
    <!-- KHU V·ª∞C TRA C·ª®U ƒê∆†N H√ÄNG (TH√äM M·ªöI V√ÄO ƒê√ÇY) -->
    <!-- ============================================== -->
    <section class="lookup-section">
        <div class="lookup-header">
            <h3><i class="fa-solid fa-magnifying-glass"></i> Tra C·ª©u ƒê∆°n H√†ng C≈©</h3>
            <p>Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ xem tr·∫°ng th√°i ƒë∆°n h√†ng & l·∫•y m√£ Feedback</p>
        </div>

        <div class="lookup-form">
            <input type="tel" id="lookup-phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n...">
            <button onclick="lookupOrder()" id="btn-lookup">Ki·ªÉm Tra</button>
        </div>

        <!-- Khu v·ª±c hi·ªÉn th·ªã k·∫øt qu·∫£ -->
        <div id="lookup-results"></div>
    </section>

  </main>

 <!-- Messenger Chat Plugin Code -->
<div id="fb-root"></div>
<div id="fb-customer-chat" class="fb-customerchat"></div>

<script>
  var chatbox = document.getElementById('fb-customer-chat');
  chatbox.setAttribute("page_id", "61582495130534N");
  chatbox.setAttribute("attribution", "biz_inbox");
  window.fbAsyncInit = function() {
    FB.init({ xfbml : true, version : 'v18.0' });
  };
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = 'https://connect.facebook.net/vi_VN/sdk/xfbml.customerchat.js';
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

  <script>
    // --- API ENDPOINT CHUNG ---
    const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwo1JtpJ-2ASGMNhz1jJwb8AWmsCyPI-1I0xn9pzKFwcaTvnjxcIQDCC2QGzXAuAxbwcg/exec';

    // === LOGIC T√çNH GI√Å TI·ªÄN ===
    function calculateSockPrice(size, qty) {
        let price = 0;
        if (size === 'S') {
            if (qty >= 10) price = 6000; else if (qty >= 5) price = 8000; else price = 10000;
        } else if (size === 'M') {
            if (qty >= 10) price = 8000; else if (qty >= 5) price = 10000; else price = 12000;
        } else if (size === 'L') {
            if (qty >= 10) price = 10000; else if (qty >= 5) price = 12000; else price = 14000;
        }
        return price;
    }

    function renderCart() {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        let tbody = document.getElementById('cart-body');
        let totalEl = document.getElementById('cart-total');
        tbody.innerHTML = '';
        let grandTotal = 0;

        if (cart.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Gi·ªè h√†ng tr·ªëng</td></tr>';
            document.getElementById('checkout-section').style.display = 'none';
            totalEl.innerText = '0‚Ç´';
            return;
        } else {
            document.getElementById('checkout-section').style.display = 'block';
        }

        cart.forEach((item, index) => {
            let unitPrice = (item.type === 'sock') ? calculateSockPrice(item.size, item.quantity) : item.price;
            let subTotal = unitPrice * item.quantity;
            grandTotal += subTotal;

            let row = `
                <tr>
                    <td>
                        <strong>${item.name}</strong><br>
                        ${item.type === 'sock' ? `<small>Size: ${item.size}, M√†u: ${item.color}</small>` : ''}
                    </td>
                    <td>${item.quantity}</td>
                    <td>${unitPrice.toLocaleString('vi-VN')}‚Ç´</td>
                    <td>${subTotal.toLocaleString('vi-VN')}‚Ç´</td>
                    <td><button onclick="removeItem(${index})" style="color:red; border:none; background:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        totalEl.innerText = grandTotal.toLocaleString('vi-VN') + '‚Ç´';
    }

    function removeItem(index) {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        cart.splice(index, 1);
        localStorage.setItem('myCart', JSON.stringify(cart));
        renderCart();
    }

    // === LOGIC THANH TO√ÅN ===
    let selectedPayment = null;

    function selectPayment(method) {
        selectedPayment = method;
        document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('active'));
        document.getElementById('qr-code-image').style.display = 'none';

        if (method === 'cod') {
            document.getElementById('pay-cod').classList.add('active');
        } else if (method === 'qr') {
            document.getElementById('pay-qr').classList.add('active');
            document.getElementById('qr-code-image').style.display = 'block';
        }
    }

    async function checkout() {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        if (cart.length === 0) { alert("Gi·ªè h√†ng tr·ªëng!"); return; }

        let name = document.getElementById('cus-name').value.trim();
        let address = document.getElementById('cus-address').value.trim();
        let phone = document.getElementById('cus-phone').value.trim();

        if (name === "") { alert("Vui l√≤ng nh·∫≠p t√™n!"); document.getElementById('cus-name').focus(); return; }
        if (address === "") { alert("Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ!"); document.getElementById('cus-address').focus(); return; }
        if (phone === "") { alert("Vui l√≤ng nh·∫≠p SƒêT!"); document.getElementById('cus-phone').focus(); return; }
        if (!selectedPayment) { alert("Vui l√≤ng ch·ªçn thanh to√°n!"); return; }

        let orderData = {
            customer: { name: name, phone: phone, address: address },
            payment_method: selectedPayment,
            items: cart,
            total_price: document.getElementById('cart-total').innerText
        };

        let btn = document.querySelector('.btn-checkout');
        let originalText = btn.innerText;
        btn.innerText = "ƒêang g·ª≠i ƒë∆°n h√†ng...";
        btn.disabled = true;

        try {
            await fetch(API_ENDPOINT, {
                method: 'POST',
                mode: 'no-cors', // D√πng cho ƒë·∫∑t h√†ng ƒë·ªÉ tr√°nh l·ªói CORS khi ghi d·ªØ li·ªáu
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });
            alert("üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng! Ch√∫ng t√¥i s·∫Ω li√™n h·ªá s·ªõm.");
            localStorage.removeItem('myCart');
            window.location.href = 'index.html';

        } catch (error) {
            console.error("L·ªói:", error);
            alert("‚ö†Ô∏è L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau.");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    // === LOGIC TRA C·ª®U ƒê∆†N H√ÄNG (M·ªöI) ===
    function lookupOrder() {
        const phone = document.getElementById('lookup-phone').value.trim();
        const btn = document.getElementById('btn-lookup');
        const resultDiv = document.getElementById('lookup-results');

        if (!phone) {
            alert("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i c·∫ßn tra c·ª©u!");
            return;
        }

        // Hi·ªáu ·ª©ng ƒëang t·∫£i
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        btn.disabled = true;
        resultDiv.innerHTML = "";

        fetch(API_ENDPOINT, {
            method: 'POST',
            // L∆ØU √ù: Tra c·ª©u c·∫ßn ƒë·ªçc d·ªØ li·ªáu tr·∫£ v·ªÅ n√™n KH√îNG d√πng 'no-cors'
            // ƒê·∫£m b·∫£o Script Google ƒë√£ deploy quy·ªÅn "Anyone"
            body: JSON.stringify({
                type: 'lookup', // B√°o cho Google Script bi·∫øt ƒë√¢y l√† tra c·ª©u
                phone: phone
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.result === 'success') {
                let html = `<p style="margin-bottom:10px; color:#27ae60;">T√¨m th·∫•y <strong>${data.orders.length}</strong> ƒë∆°n h√†ng:</p>`;
                
                data.orders.forEach(order => {
                    // M√†u s·∫Øc tr·∫°ng th√°i
                    let statusClass = '';
                    if (order.status.includes('Ch·ªù')) statusClass = 'status-pending';
                    else if (order.status.includes('ƒêang')) statusClass = 'status-shipping';
                    else if (order.status.includes('ƒê√£')) statusClass = 'status-done';
                    else if (order.status.includes('H·ªßy')) statusClass = 'status-cancel';

                    // M√£ Feedback
                    let feedbackHtml = '';
                    if (order.fb_code) {
                        feedbackHtml = `
                            <div class="fb-code-box">
                                üéÅ M√£ Feedback: <strong>${order.fb_code}</strong>
                                <div style="font-size:0.8rem; margin-top:2px;">(D√πng m√£ n√†y ƒë·ªÉ ƒë√°nh gi√° s·∫£n ph·∫©m)</div>
                            </div>
                        `;
                    }

                    html += `
                        <div class="order-history-item ${statusClass}">
                            <div class="history-header">
                                <span>üìÖ ${order.date}</span>
                            </div>
                            <div class="history-body">
                                ${order.products}
                            </div>
                            <div class="history-footer">
                                <span class="history-price">${order.total}</span>
                                <span class="history-status">${order.status}</span>
                            </div>
                            ${feedbackHtml}
                        </div>
                    `;
                });
                resultDiv.innerHTML = html;
            } else {
                resultDiv.innerHTML = `<div style="color:red; text-align:center; padding:10px;">üö´ ${data.message}</div>`;
            }
        })
        .catch(err => {
            console.error(err);
            alert("L·ªói k·∫øt n·ªëi server ho·∫∑c ch∆∞a t√¨m th·∫•y ƒë∆°n h√†ng!");
        })
        .finally(() => {
            btn.innerHTML = "Ki·ªÉm Tra";
            btn.disabled = false;
        });
    }

    // Ch·∫°y khi t·∫£i trang
    renderCart();
  </script>

</body>
</html>
