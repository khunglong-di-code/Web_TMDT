<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Giỏ hàng | Tất Tần Tập</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="site-header">
        <div class="header-inner">
          <a class="logo" href="index.html">
            <img src="image/Tattantap_logo1.png" alt="Logo">
          </a>
          <nav class="main-nav">
            <ul>
              <!-- Đã bỏ class active ở đây -->
              <li><a href="index.html">Trang chủ</a></li>      
              <li><a href="about.html">Về chúng tôi</a></li>
              <li><a href="products.html">Cửa hàng</a></li>
              <li><a href="faq.html">Hỗ trợ</a></li>
            </ul>
          </nav>
          <div class="header-actions">
              <!-- Thêm style color để làm nổi bật icon giỏ hàng -->
              <a class="cart-link" href="cart.html" style="color: #d35400;">
                <i class="fa-solid fa-bag-shopping"></i>
                <span class="cart-count" id="cart-count">0</span>
              </a>
          </div>
        </div>
      </header>

  <main class="cart-section">
    <h1>Giỏ hàng của bạn</h1>
    
    <table class="cart-table">
        <thead>
            <tr>
                <th>Sản phẩm</th>
                <th>Số lượng</th>
                <th>Đơn giá (theo mức)</th>
                <th>Thành tiền</th>
                <th>Xóa</th>
            </tr>
        </thead>
        <tbody id="cart-body">
            </tbody>
    </table>

    <div class="total-section">
        Tổng cộng: <span id="cart-total" style="color: #f08146; font-size: 1.5rem;">0₫</span>
    </div>

<!-- Tìm đoạn này trong cart.html và sửa lại giống hệt bên dưới -->
<div class="checkout-form" id="checkout-section">
    <h2>Thông tin thanh toán</h2>
    <div class="form-group">
        <label>Họ và tên:</label>
        <!-- Thêm id="cus-name" -->
        <input type="text" id="cus-name" placeholder="Nhập họ tên của bạn">
    </div>
    <div class="form-group">
        <label>Địa chỉ giao hàng:</label>
        <!-- Thêm id="cus-address" -->
        <textarea rows="3" id="cus-address" placeholder="Số nhà, đường, quận/huyện..."></textarea>
    </div>
    <div class="form-group">
        <label>Số điện thoại:</label>
        <!-- Thêm id="cus-phone" -->
        <input type="tel" id="cus-phone" placeholder="09xxx...">
    </div>

    <!-- ... Các phần bên dưới giữ nguyên ... -->

        <div class="form-group">
            <label>Hình thức thanh toán:</label>
            <div class="payment-methods">
                <div class="payment-option" onclick="selectPayment('cod')" id="pay-cod">
                    <i class="fa-solid fa-truck"></i> COD (Tiền mặt)
                </div>
                <div class="payment-option" onclick="selectPayment('qr')" id="pay-qr">
                    <i class="fa-solid fa-qrcode"></i> Chuyển khoản QR
                </div>
            </div>
            
            <div id="qr-code-image">
                <p>Vui lòng quét mã bên dưới:</p>
                <img src="https://via.placeholder.com/200x200.png?text=QR+Code+Here" alt="Mã QR Chuyển khoản">
                <p>Nội dung CK: Tên + SĐT</p>
            </div>
        </div>

        <button class="btn-checkout" onclick="checkout()">ĐẶT HÀNG NGAY</button>
    </div>

  </main>

  <a href="https://m.me/61582495130534" target="_blank" class="chat-widget" title="Chat Facebook">
    <i class="fa-brands fa-facebook-messenger"></i>
  </a>

  <script>
    // === LOGIC TÍNH GIÁ TIỀN (QUAN TRỌNG) ===
    function calculateSockPrice(size, qty) {
        let price = 0;
        // Size S (Nhỏ)
        if (size === 'S') {
            if (qty >= 10) price = 6000;
            else if (qty >= 5) price = 8000;
            else price = 10000;
        } 
        // Size M (Vừa)
        else if (size === 'M') {
            if (qty >= 10) price = 8000;
            else if (qty >= 5) price = 10000;
            else price = 12000;
        }
        // Size L (Lớn)
        else if (size === 'L') {
            if (qty >= 10) price = 10000;
            else if (qty >= 5) price = 12000;
            else price = 14000;
        }
        return price;
    }

    function renderCart() {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        let tbody = document.getElementById('cart-body');
        let totalEl = document.getElementById('cart-total');
        tbody.innerHTML = '';
        let grandTotal = 0;

        if (cart.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Giỏ hàng trống</td></tr>';
            document.getElementById('checkout-section').style.display = 'none';
            totalEl.innerText = '0₫';
            return;
        } else {
            document.getElementById('checkout-section').style.display = 'block';
        }

        cart.forEach((item, index) => {
            let unitPrice = 0;

            if (item.type === 'sock') {
                unitPrice = calculateSockPrice(item.size, item.quantity);
            } else {
                unitPrice = item.price; // Giá cố định cho Sổ
            }

            let subTotal = unitPrice * item.quantity;
            grandTotal += subTotal;

            let row = `
                <tr>
                    <td>
                        <strong>${item.name}</strong><br>
                        ${item.type === 'sock' ? `<small>Size: ${item.size}, Màu: ${item.color}</small>` : ''}
                    </td>
                    <td>${item.quantity}</td>
                    <td>${unitPrice.toLocaleString('vi-VN')}₫</td>
                    <td>${subTotal.toLocaleString('vi-VN')}₫</td>
                    <td><button onclick="removeItem(${index})" style="color:red; border:none; background:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        totalEl.innerText = grandTotal.toLocaleString('vi-VN') + '₫';
    }

    function removeItem(index) {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        cart.splice(index, 1);
        localStorage.setItem('myCart', JSON.stringify(cart));
        renderCart();
    }

    // === LOGIC THANH TOÁN ===
    let selectedPayment = null;

    function selectPayment(method) {
        selectedPayment = method;
        // Reset style
        document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('active'));
        document.getElementById('qr-code-image').style.display = 'none';

        // Set active
        if (method === 'cod') {
            document.getElementById('pay-cod').classList.add('active');
        } else if (method === 'qr') {
            document.getElementById('pay-qr').classList.add('active');
            document.getElementById('qr-code-image').style.display = 'block';
        }
    }

    function checkout() {
        // 1. Kiểm tra giỏ hàng có trống không
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        if (cart.length === 0) {
            alert("Giỏ hàng của bạn đang trống!");
            return;
        }

        // 2. Lấy giá trị từ các ô nhập liệu
        let name = document.getElementById('cus-name').value.trim();
        let address = document.getElementById('cus-address').value.trim();
        let phone = document.getElementById('cus-phone').value.trim();

        // --- BẮT ĐẦU KIỂM TRA THÔNG TIN (VALIDATION) ---
        
        if (name === "") {
            alert("Vui lòng nhập Họ và tên của bạn!");
            document.getElementById('cus-name').focus(); // Đưa con trỏ chuột về ô này
            return; // Dừng hàm lại, không chạy tiếp
        }

        if (address === "") {
            alert("Vui lòng nhập Địa chỉ giao hàng!");
            document.getElementById('cus-address').focus();
            return;
        }

        if (phone === "") {
            alert("Vui lòng nhập Số điện thoại để chúng tôi liên hệ!");
            document.getElementById('cus-phone').focus();
            return;
        }

        // Kiểm tra số điện thoại có đúng định dạng số không (cơ bản)
        // Regex này kiểm tra: Bắt đầu bằng số 0, theo sau là 9 chữ số
        let phoneRegex = /(0[3|5|7|8|9])+([0-9]{8})\b/;
        if (!phoneRegex.test(phone)) {
             alert("Số điện thoại không hợp lệ! Vui lòng kiểm tra lại (10 số, bắt đầu bằng 0).");
             document.getElementById('cus-phone').focus();
             return;
        }

        // 3. Kiểm tra hình thức thanh toán
        if (!selectedPayment) {
            alert("Vui lòng chọn hình thức thanh toán (COD hoặc QR)!");
            return;
        }

        // --- NẾU VƯỢT QUA HẾT CÁC BƯỚC TRÊN THÌ MỚI XỬ LÝ ĐẶT HÀNG ---
        
        // Tạo nội dung đơn hàng để gửi mail (như đã hướng dẫn ở câu trả lời trước)
        let orderContent = `ĐƠN HÀNG MỚI\nKhách hàng: ${name}\nSĐT: ${phone}\nĐịa chỉ: ${address}\n\nCHI TIẾT: \n`;
        let total = 0;
        
        cart.forEach(item => {
            let unitPrice = item.type === 'sock' ? calculateSockPrice(item.size, item.quantity) : item.price;
            let subTotal = unitPrice * item.quantity;
            total += subTotal;
            orderContent += `- ${item.name} x ${item.quantity}: ${subTotal.toLocaleString('vi-VN')}đ\n`;
        });
        
        orderContent += `\nTổng cộng: ${total.toLocaleString('vi-VN')}đ\nThanh toán: ${selectedPayment === 'cod' ? 'Tiền mặt' : 'Chuyển khoản'}`;

        // Gửi qua mailto
        let emailTo = "lienhe@tattantap.com";
        let subject = encodeURIComponent(`Đặt hàng từ ${name} - ${phone}`);
        let body = encodeURIComponent(orderContent);
        
        window.location.href = `mailto:${emailTo}?subject=${subject}&body=${body}`;

        // Xác nhận xóa giỏ hàng
        if(confirm("Đã chuyển sang ứng dụng Email. Bạn đã gửi thư chưa? Bấm OK để hoàn tất và xóa giỏ hàng.")) {
            localStorage.removeItem('myCart');
            window.location.href = 'index.html';
        }
    }

    // Chạy khi tải trang
    renderCart();
  </script>

</body>
</html>