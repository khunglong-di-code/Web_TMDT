<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chi Tiết Sản Phẩm | Tất Tần Tập</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="image/logo.png" type="image/png">

  <style>
    /* CSS CƠ BẢN */
    :root { --primary-color: #ff6600; --secondary-color: #333; }
    .detail-container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 50px; align-items: start; }
    
    /* CỘT TRÁI: ẢNH + FEEDBACK */
    .gallery-wrapper { position: sticky; top: 20px; }
    .main-image-frame { width: 100%; height: 500px; border: 1px solid #eee; border-radius: 12px; overflow: hidden; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; background: #fff; }
    .main-image-frame img { width: 100%; height: 100%; object-fit: cover; }
    .thumbnail-list { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 30px; }
    .thumb-item { width: 80px; height: 80px; border: 2px solid transparent; border-radius: 8px; cursor: pointer; object-fit: cover; opacity: 0.7; transition: 0.3s; }
    .thumb-item:hover, .thumb-item.active { border-color: var(--primary-color); opacity: 1; }

    /* CSS CHO PHẦN FEEDBACK */
    .feedback-area { border-top: 2px solid #eee; padding-top: 20px; margin-top: 20px; }
    .feedback-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; color: var(--secondary-color); border-left: 4px solid var(--primary-color); padding-left: 10px; }
    
    .review-list { max-height: 300px; overflow-y: auto; margin-bottom: 20px; padding-right: 5px; border-bottom: 1px dashed #eee;}
    .review-list::-webkit-scrollbar { width: 5px; }
    .review-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    
    .review-item { background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.95rem; }
    .review-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .reviewer-name { font-weight: bold; color: #333; }
    .review-stars { color: #f1c40f; letter-spacing: 2px; }
    .review-content { color: #555; line-height: 1.4; white-space: pre-line; }
    .review-date { font-size: 0.75rem; color: #999; margin-top: 6px; text-align: right; display: block; font-style: italic;}

    .feedback-form input, .feedback-form textarea, .feedback-form select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; }
    .btn-submit-fb { background: #333; color: #fff; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; }
    .btn-submit-fb:hover { background: var(--primary-color); }
    .btn-submit-fb:disabled { background: #ccc; cursor: not-allowed; }

    /* CỘT PHẢI: INFO */
    .product-title { font-size: 2rem; color: var(--secondary-color); margin-bottom: 10px; }
    .product-price { font-size: 1.5rem; color: var(--primary-color); font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
    .product-desc { color: #555; margin-bottom: 30px; line-height: 1.8; text-align: justify; }
    .control-group { margin-bottom: 20px; }
    .control-group label { display: block; font-weight: bold; margin-bottom: 8px; }
    .control-group select, .control-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
    .btn-add-cart { width: 100%; background: var(--secondary-color); color: white; padding: 18px; border: none; border-radius: 8px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; margin-top: 20px; }
    .btn-add-cart:hover { background: var(--primary-color); }

    @media (max-width: 768px) {
        .detail-grid { grid-template-columns: 1fr; gap: 30px; }
        .main-image-frame { height: 350px; }
        .gallery-wrapper { position: static; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="index.html"><img src="image/Tattantap_logo1.png" alt="Logo"></a>
      <nav class="main-nav">
        <ul>
          <li><a href="index.html">Trang chủ</a></li>      
          <li><a href="about.html">Về chúng tôi</a></li>
          <li><a href="products.html" class="active">Cửa hàng</a></li>
          <li><a href="faq.html">Hỗ trợ</a></li>
        </ul>
      </nav>
      <div class="header-actions">
          <a class="cart-link" href="cart.html">
            <i class="fa-solid fa-bag-shopping"></i>
            <span class="cart-count" id="cart-count">0</span>
          </a>
      </div>
    </div>
  </header>

  <!-- NỘI DUNG CHÍNH -->
  <main class="detail-container">
      <div class="detail-grid">
          
          <!-- CỘT TRÁI: ẢNH & FEEDBACK -->
          <div class="gallery-wrapper">
              <div class="main-image-frame">
                  <img id="main-img" src="" alt="Ảnh sản phẩm">
              </div>
              <div class="thumbnail-list" id="thumb-container"></div>

              <!-- PHẦN FEEDBACK (ĐÃ TÍCH HỢP API) -->
              <div class="feedback-area">
                  <h3 class="feedback-title">Feedback Khách Hàng</h3>
                  
                  <!-- Danh sách hiển thị -->
                  <div id="review-list" class="review-list">
                      <div style="text-align:center; padding:15px; color:#666;">
                          <i class="fa-solid fa-spinner fa-spin"></i> Đang tải đánh giá...
                      </div>
                  </div>

                  <!-- Form gửi -->
                  <form class="feedback-form" onsubmit="return false;">
                      <h4 style="margin-bottom: 10px; font-size:1rem;">Gửi feedback của bạn</h4>
                      <input type="text" id="fb-name" placeholder="Tên hiển thị (VD: Lan Anh)">
                      <input type="text" id="fb-code" placeholder="Nhập mã đơn hàng (Bắt buộc)*">
                      <select id="fb-rating">
                          <option value="5">⭐⭐⭐⭐⭐ - Tuyệt vời</option>
                          <option value="4">⭐⭐⭐⭐ - Hài lòng</option>
                          <option value="3">⭐⭐⭐ - Bình thường</option>
                          <option value="2">⭐⭐ - Tệ</option>
                          <option value="1">⭐ - Rất tệ</option>
                      </select>
                      <textarea id="fb-comment" rows="3" placeholder="Chia sẻ cảm nhận về sản phẩm..."></textarea>
                      <button class="btn-submit-fb" id="btn-submit" onclick="submitFeedback()">GỬI FEEDBACK</button>
                  </form>
              </div>
          </div>

          <!-- CỘT PHẢI: THÔNG TIN SẢN PHẨM -->
          <div class="info-wrapper">
              <h1 class="product-title" id="p-name">Đang tải...</h1>
              <div class="product-price" id="p-price">0₫</div>
              <div class="product-desc" id="p-desc"></div>

              <div id="options-area">
                  <div class="control-group" id="opt-size">
                      <label>Kích thước:</label>
                      <select id="sel-size" onchange="updatePrice()">
                          <option value="S">Nhỏ (S)</option>
                          <option value="M">Vừa (M)</option>
                          <option value="L">Lớn (L)</option>
                      </select>
                  </div>
                  <div class="control-group" id="opt-color">
                      <label>Màu sắc:</label>
                      <select id="sel-color" onchange="updatePrice()">
                          <option value="Trắng">Trắng</option>
                          <option value="Đen">Đen</option>
                      </select>
                  </div>
              </div>

              <div class="control-group">
                  <label>Số lượng:</label>
                  <input type="number" id="sel-qty" value="1" min="1" onchange="updatePrice()">
              </div>

              <button class="btn-add-cart" onclick="addToCart()">Thêm Vào Giỏ Hàng</button>
          </div>
      </div>
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="footer-grid">
      <div class="footer-col">
        <h4>Về Tất Tần Tập</h4>
        <p>Chúng tôi cung cấp các sản phẩm văn phòng phẩm và phụ kiện thời trang tối giản.</p>
        <a href="http://online.gov.vn/Home/WebDetails/10940" target="_blank"><img src="image_dcd887.png" alt="BCT" class="bct-logo" style="width:150px; margin-top:10px;"></a>
      </div>
      <div class="footer-col">
        <h4>Liên Hệ</h4>
        <p><i class="fa-solid fa-location-dot"></i> Hai Bà Trưng, Hà Nội</p>
        <p><i class="fa-solid fa-phone"></i> 0967 067 332</p>
      </div>
    </div>
    <div class="copyright">
        <div style="text-align: center; padding: 15px;">© 2025 Tất Tần Tập.</div>
    </div>
  </footer>

 <!-- SCRIPT XỬ LÝ -->
  <script>
    // --- 1. CẤU HÌNH API ---
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwg7NjJmkQ_12OOHY8pQWaWBtdv5BHQjzSVOqYzrefHcrJw97lMdKRYMY8jwvceaHCbbQ/exec";

    // --- 2. DỮ LIỆU SẢN PHẨM (MOCK DATA) ---
    const productsDB = {
        'sock': {
            name: "Tất Cotton Premium",
            type: 'sock',
            images: ["image/1.png", "image/conganden.png", "image/colung1den.png"],
            desc: "<p><strong>Chất liệu:</strong> 90% Cotton tự nhiên, 10% Spandex giúp co giãn 4 chiều.</p>"
        },
        'book': {
            name: "Sổ Tay Minimalist",
            type: 'book',
            price_fixed: 35000,
            images: ["image/sach1.png", "image/sach2.png"],
            desc: "<p><strong>Loại giấy:</strong> Giấy kem ngà chống lóa, định lượng 100gsm dày dặn.</p>"
        }
    };

    const params = new URLSearchParams(window.location.search);
    const productId = params.get('id') || 'sock'; // Mặc định là sock
    const productData = productsDB[productId];

    // --- 3. KHỞI TẠO TRANG ---
    function initPage() {
        if (!productData) {
            document.querySelector('.detail-container').innerHTML = "<h2>Không tìm thấy sản phẩm!</h2>";
            return;
        }

        // Hiển thị thông tin
        document.getElementById('p-name').innerText = productData.name;
        document.getElementById('p-desc').innerHTML = productData.desc;
        
        const mainImg = document.getElementById('main-img');
        const thumbContainer = document.getElementById('thumb-container');
        mainImg.src = productData.images[0];

        productData.images.forEach((src, index) => {
            let thumb = document.createElement('img');
            thumb.src = src;
            thumb.className = index === 0 ? 'thumb-item active' : 'thumb-item';
            thumb.onclick = () => {
                mainImg.src = src;
                document.querySelectorAll('.thumb-item').forEach(el => el.classList.remove('active'));
                thumb.classList.add('active');
            }
            thumbContainer.appendChild(thumb);
        });

        if (productData.type === 'book') {
            document.getElementById('options-area').style.display = 'none';
        }

        updatePrice();
        updateCartCount();
        
        // GỌI HÀM TẢI FEEDBACK TỪ API
        loadReviewsFromSheet();
    }

    // --- 4. LOGIC GIÁ & GIỎ HÀNG (ĐÃ SỬA) ---
    function updatePrice() {
        const qty = parseInt(document.getElementById('sel-qty').value) || 1;
        let unitPrice = 0;
        if (productData.type === 'sock') {
            const size = document.getElementById('sel-size').value;
            unitPrice = (size === 'S') ? 10000 : (size === 'M') ? 12000 : 14000;
            if(qty >= 5) unitPrice -= 2000;
        } else {
            unitPrice = productData.price_fixed;
        }
        document.getElementById('p-price').innerText = `${(unitPrice * qty).toLocaleString('vi-VN')}₫`;
    }

    // --- HÀM ADD TO CART ĐƯỢC SỬA LẠI ---
    function addToCart() {
        const qtyInput = document.getElementById('sel-qty');
        const qty = parseInt(qtyInput.value) || 1;

        // Tạo object sản phẩm để lưu
        let item = {
            id: productId,
            name: productData.name,
            type: productData.type,
            quantity: qty,
            image: productData.images[0]
        };

        // Lấy thông tin size/màu nếu là tất
        if (productData.type === 'sock') {
            item.size = document.getElementById('sel-size').value;
            item.color = document.getElementById('sel-color').value;
            item.price = 0; // Giá tất sẽ được tính lại trong cart.html dựa trên tổng số lượng
        } else {
            // Sách hoặc sản phẩm khác có giá cố định
            item.price = productData.price_fixed;
            item.size = "";  // Không có size
            item.color = ""; // Không có màu
        }

        // Lấy giỏ hàng cũ từ LocalStorage
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];

        // Kiểm tra xem sản phẩm này (cùng size, cùng màu) đã có trong giỏ chưa
        let existingItem = cart.find(x => x.id === item.id && x.size === item.size && x.color === item.color);

        if (existingItem) {
            existingItem.quantity += qty; // Nếu có rồi thì cộng thêm số lượng
        } else {
            cart.push(item); // Nếu chưa thì thêm mới
        }

        // Lưu ngược lại vào LocalStorage
        localStorage.setItem('myCart', JSON.stringify(cart));

        // Cập nhật số lượng trên icon giỏ hàng header ngay lập tức
        updateCartCount();

        alert(`Đã thêm ${qty} sản phẩm "${item.name}" vào giỏ hàng!`);
    }

    function updateCartCount() {
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];
        let total = cart.reduce((acc, item) => acc + item.quantity, 0);
        document.getElementById('cart-count').innerText = total;
    }

    // --- 5. TÍNH NĂNG FEEDBACK (KẾT NỐI API) ---

    // A. Tải danh sách đánh giá
    function loadReviewsFromSheet() {
        const list = document.getElementById('review-list');
        
        // Gọi API với tham số id sản phẩm
        fetch(`${GOOGLE_SCRIPT_URL}?id=${productId}`)
            .then(response => response.json())
            .then(data => {
                list.innerHTML = ""; // Xóa icon loading
                
                if (!Array.isArray(data) || data.length === 0) {
                    list.innerHTML = '<div style="text-align:center; color:#999; padding:15px;">Chưa có feedback nào. Hãy là người đầu tiên!</div>';
                    return;
                }

                data.forEach(rv => {
                    const stars = '★'.repeat(rv.rating) + '☆'.repeat(5 - rv.rating);
                    const dateStr = new Date(rv.date).toLocaleDateString('vi-VN');
                    
                    const html = `
                        <div class="review-item">
                            <div class="review-header">
                                <span class="reviewer-name">${rv.name}</span>
                                <span class="review-stars">${stars}</span>
                            </div>
                            <div class="review-content">${rv.comment}</div>
                            <span class="review-date">${dateStr}</span>
                        </div>
                    `;
                    list.insertAdjacentHTML('beforeend', html);
                });
            })
            .catch(error => {
                console.error('Lỗi tải feedback:', error);
                list.innerHTML = '<div style="color:red; text-align:center; padding:10px;">Không tải được đánh giá.</div>';
            });
    }

    // B. Gửi đánh giá mới
    function submitFeedback() {
        const name = document.getElementById('fb-name').value.trim() || 'Khách hàng';
        const code = document.getElementById('fb-code').value.trim();
        const rating = document.getElementById('fb-rating').value;
        const comment = document.getElementById('fb-comment').value.trim();
        const btn = document.getElementById('btn-submit');

        if (!code) { 
            alert("Vui lòng nhập Mã đơn hàng để xác minh!"); 
            document.getElementById('fb-code').focus();
            return; 
        }
        if (!comment) { 
            alert("Bạn hãy viết vài lời nhận xét nhé!"); 
            document.getElementById('fb-comment').focus();
            return; 
        }

        // Khóa nút submit
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang gửi...';
        btn.disabled = true;

        // Tạo gói dữ liệu gửi đi (QUAN TRỌNG: type='feedback')
        const payload = {
            type: 'feedback', // Để server biết đây là feedback chứ không phải đặt hàng
            product_id: productId,
            name: name,
            code: code,
            rating: rating,
            comment: comment
        };

        // Gửi POST request
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(payload) // App Script sẽ đọc qua e.postData.contents
        })
        .then(response => response.json())
        .then(data => {
            if (data.result === 'success') {
                alert("✅ Cảm ơn bạn! Feedback đã được ghi nhận.");
                
                // Xóa form
                document.getElementById('fb-comment').value = '';
                document.getElementById('fb-code').value = '';
                document.getElementById('fb-name').value = '';

                // Tải lại danh sách ngay lập tức
                loadReviewsFromSheet();
            } 
            else if (data.result === 'duplicate') {
                alert("⚠️ Lỗi: Mã đơn hàng này đã được sử dụng để đánh giá rồi!");
                document.getElementById('fb-code').focus();
            } 
            else {
                alert("❌ Lỗi server: " + (data.message || data.error));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Có lỗi kết nối. Vui lòng thử lại sau!");
        })
        .finally(() => {
            // Mở lại nút submit
            btn.innerHTML = 'GỬI FEEDBACK';
            btn.disabled = false;
        });
    }

    // Chạy khi tải trang
    initPage();
  </script>

</body>
</html>
